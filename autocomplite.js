'use strict';var _createClass=function(){function a(b,c){for(var e,d=0;d<c.length;d++)e=c[d],e.enumerable=e.enumerable||!1,e.configurable=!0,'value'in e&&(e.writable=!0),Object.defineProperty(b,e.key,e)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')}var AutocompliteCity=function(){function a(){_classCallCheck(this,a),this.options={ajax_url:'kladr.json',is_value:!1,is_connection_error:!1,is_frame:!1,is_data:!1,is_loading:!1,is_results:!1,is_selected:!1,is_selecting:!1,select_value:-1,reaction_time:500,loading_min_time:1e3,max_result_size:5,all_result_size:0,load_start_time:0,gap_between_width:60,messages:{connection_error:'\u0427\u0442\u043E-\u0442\u043E \u043F\u043E\u0448\u043B\u043E \u043D\u0435 \u0442\u0430\u043A. \u041F\u0440\u043E\u0432\u0435\u0440\u044C\u0442\u0435 \u0441\u043E\u0435\u0434\u0438\u043D\u0435\u043D\u0438\u0435 \u0441 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u043E\u043C \u0438 \u043F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u0435\u0449\u0451 \u0440\u0430\u0437',choice_error:'\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0437\u043D\u0430\u0447\u0435\u043D\u0438\u0435 \u0438\u0437 \u0441\u043F\u0438\u0441\u043A\u0430',loading:'\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430',no_results:'\u041D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u043E',lot_results:'\u041F\u043E\u043A\u0430\u0437\u0430\u043D\u043E %limit% \u0438\u0437 %max% \u043D\u0430\u0439\u0434\u0435\u043D\u043D\u044B\u0445 \u0433\u043E\u0440\u043E\u0434\u043E\u0432. \u0423\u0442\u043E\u0447\u043D\u0438\u0442\u0435 \u0437\u0430\u043F\u0440\u043E\u0441, \u0447\u0442\u043E\u0431\u044B \u0443\u0432\u0438\u0434\u0435\u0442\u044C \u043E\u0441\u0442\u0430\u043B\u044C\u043D\u044B\u0435'}},this.layout={},this.data={}}return _createClass(a,[{key:'init',value:function init(b,c){b instanceof HTMLElement&&'INPUT'===b.nodeName&&'function'==typeof c&&(this.layout.input=b,this.options.validation=c,this.layout.input.addEventListener('focus',this._on_focus.bind(this),!1),this.layout.input.addEventListener('keydown',this._on_keydown.bind(this),!1),this.layout.input.addEventListener('keyup',this._on_keyup.bind(this),!1),this.layout.input.addEventListener('input',this._on_input.bind(this),!1),this.layout.input.addEventListener('blur',this._on_blur.bind(this),!1))}},{key:'checkPosition',value:function checkPosition(){this._set_metrics()}},{key:'_get_metrics',value:function _get_metrics(){var b=this.layout.input.getBoundingClientRect();return{min_width:this.layout.input.offsetWidth,x:b.left+pageXOffset,y:b.top+pageYOffset+this.layout.input.offsetHeight}}},{key:'_set_metrics',value:function _set_metrics(){this.layout.frame.style.minWidth=this._get_metrics().min_width+this.options.gap_between_width+'px',this.layout.frame.style.left=this._get_metrics().x+'px',this.layout.frame.style.top=this._get_metrics().y+'px'}},{key:'_on_focus',value:function _on_focus(){this._on_input()}},{key:'_on_input',value:function _on_input(){var c=function(d){return d=d.trim().replace(/\s{2,}/g,' '),d=' '!=d&&d,d}(this.layout.input.value);return(this.options.select_value=-1,!c)?(this.options.query='',this.options.is_value=!1,void this._hide_frame()):(this.options.query=c,this.options.is_value=!0,this.options.is_data||this.options.is_loading?this.options.is_data?void this._parse_results():void 0:(this.options.is_loading=!0,void this._load_data(this._parse_results.bind(this))))}},{key:'_on_keydown',value:function _on_keydown(){function b(c,d){for(var e=0;e<c.children.length;++e)c.children[e].className=c.children[e].className.replace('autocomplite__item--state--hover','');0<=d&&(c.children[d].className+=' autocomplite__item--state--hover')}27===event.keyCode&&this._hide_frame(),38===event.keyCode&&(event.preventDefault?event.preventDefault():event.returnValue=!1,0<=this.options.select_value&&(this.options.select_value--,b(this.layout.results.firstChild,this.options.select_value))),40===event.keyCode&&(event.preventDefault?event.preventDefault():event.returnValue=!1,this.options.select_value<this.options.max_result_size-1&&this.options.select_value<this.options.all_result_size-1&&(this.options.select_value++,b(this.layout.results.firstChild,this.options.select_value))),13===event.keyCode&&0<=this.options.select_value&&(event.preventDefault?event.preventDefault():event.returnValue=!1,this._set_value(this.layout.results.firstChild.children[this.options.select_value].innerText),this._emulate_tab()),(13===event.keyCode||9===event.keyCode)&&1===this.options.all_result_size&&(this._set_value(this.layout.results.firstChild.firstChild.innerText),13===event.keyCode&&(event.preventDefault?event.preventDefault():event.returnValue=!1,this._emulate_tab()))}},{key:'_on_keyup',value:function _on_keyup(){(8===event.keyCode||46===event.keyCode)&&this._on_input()}},{key:'_on_blur',value:function _on_blur(){this.options.is_selecting||this._hide_frame(),!this.options.is_selecting&&0>this.options.select_value&&(1===this.options.all_result_size&&this.options.query.toLowerCase()===this.data.results[0].City.toLowerCase()&&(this.layout.input.value=this.data.results[0].City,this.options.validation(!1,this.layout.input)),this.options.is_value&&(1<this.options.all_result_size||!this.options.all_result_size)?this.options.validation(!0,this.layout.input,this.options.messages.choice_error):this.options.validation(!1,this.layout.input)),this.options.select_value=-1}},{key:'_emulate_tab',value:function _emulate_tab(){if(this.layout.input.blur(),this.layout.input.form)for(var b=this.layout.input.form.elements,c=0;c<b.length;++c)if(b[c]===this.layout.input){b[c+1].focus();break}}},{key:'_show_frame',value:function _show_frame(){return this.options.is_frame?void(this.layout.frame.className=this.layout.frame.className.replace('autocomplite--state--hide','')):void(this.layout.frame=document.createElement('div'),this.layout.frame.className='autocomplite',this.layout.frame.addEventListener('mouseenter',function(){this.options.is_selecting=!0}.bind(this),!1),this.layout.frame.addEventListener('mouseleave',function(){this.options.is_selecting=!1}.bind(this),!1),this.layout.results=document.createElement('div'),this.layout.results.className='autocomplite__results',this.layout.frame.appendChild(this.layout.results),this.layout.notifications=document.createElement('div'),this.layout.notifications.className='autocomplite__notifications',this.layout.frame.appendChild(this.layout.notifications),this.checkPosition(),document.body.appendChild(this.layout.frame),this.options.is_frame=!0)}},{key:'_hide_frame',value:function _hide_frame(){if(this.options.is_frame)return void(this.layout.frame.className+=' autocomplite--state--hide')}},{key:'_clear_frame_results',value:function _clear_frame_results(){this.layout.results.innerHTML=''}},{key:'_clear_frame_notifications',value:function _clear_frame_notifications(){this.layout.notifications.innerHTML=''}},{key:'_insert_layout',value:function _insert_layout(b,c,d,e){var f;f=document.createElement(c),d.split(' ').forEach(function(g){f.className+=' '+g}),f.innerText=e,b.innerHTML='',b.appendChild(f)}},{key:'_is_loading',value:function _is_loading(){this._show_frame(),this._insert_layout(this.layout.notifications,'div','autocomplite__notification autocomplite__notification--state--loading',this.options.messages.loading)}},{key:'_is_connection_error',value:function _is_connection_error(){this._show_frame(),this._insert_layout(this.layout.notifications,'div','autocomplite__notification autocomplite__notification--state--connection-error',this.options.messages.connection_error)}},{key:'_is_empty_result',value:function _is_empty_result(){this._show_frame(),this._insert_layout(this.layout.notifications,'div','autocomplite__notification autocomplite__notification--state--no-results',this.options.messages.no_results)}},{key:'_is_more_result',value:function _is_more_result(){this._show_frame();var b=this.options.messages.lot_results.replace(/%limit%/g,this.options.max_result_size).replace(/%max%/g,this.options.all_result_size);this._insert_layout(this.layout.notifications,'div','autocomplite__notification autocomplite__notification--state--lot-results',b)}},{key:'_show_result',value:function _show_result(){this._show_frame();var b=document.createElement('ul');for(var c in b.className='autocomplite__items',this.data.results){var d=document.createElement('li');d.className='autocomplite__item',d.innerText=this.data.results[c].City,d.addEventListener('click',this._set_value.bind(this,d.innerText),!1),b.appendChild(d)}this.layout.results.appendChild(b)}},{key:'_set_value',value:function _set_value(b){this.layout.input.query=this.layout.input.value=b,this.options.validation(!1,this.layout.input),this._hide_frame()}},{key:'_parse_results',value:function _parse_results(){this._show_frame(),this._clear_frame_results(),this._clear_frame_notifications();var b=0;for(var c in this.data.results={},this.options.is_results=!1,this.options.all_result_size=0,this.data.base){var d=this.data.base[c];(function e(f,g){f=f.toLowerCase(),g=g.toLowerCase();var h=g.indexOf(f);return!!~h&&(h&&~g.charAt(h-1).search(/[A-Za-zА-Яа-яЁё-]/)?!1:!0)})(this.options.query,d.City)&&(b<this.options.max_result_size&&(this.data.results[b]=d,b++),b==this.options.max_result_size&&!this.options.is_results&&(this.options.is_results=!0,this._show_result()),this.options.all_result_size++)}this.options.is_results||this._show_result(),this.options.all_result_size>this.options.max_result_size&&this._is_more_result(),this.options.all_result_size||this._is_empty_result()}},{key:'_load_data',value:function _load_data(b){var c=new XMLHttpRequest;this.options.is_connection_error=!1,c.open('GET',this.options.ajax_url,!0),c.send(),c.onreadystatechange=this._xhr.bind(this,c,b),setTimeout(function(){this.options.is_loading&&!this.options.is_connection_error&&this._is_loading()}.bind(this),this.options.reaction_time)}},{key:'_xhr',value:function _xhr(b,c){return 4==b.readyState?200==b.status?JSON.parse(b.responseText)?void(this.data.base=JSON.parse(b.responseText),this.options.is_data=!0,this.options.is_loading=!1,c&&this.options.is_value&&c()):(this.options.is_connection_error=!0,this.options.is_loading=!1,void this._is_connection_error()):(this.options.is_connection_error=!0,this.options.is_loading=!1,void this._is_connection_error()):void 0}}]),a}();
